{
  "module": "Chat System",
  "component": "ChatService",
  "testLevel": "Unit Test",
  "totalTestCases": 11,
  "testCases": [
    {
      "id": "TC-CS-001",
      "title": "Create Chat Session with Reconciliation Context",
      "category": "Session Creation Tests",
      "given": "reconciliation \"recon-123\" exists and user \"user-456\" belongs to organization \"org-789\"",
      "when": "createSession() is called with reconciliationId and userId",
      "then": "ChatSession entity is created with unique ID and session links to reconciliationId \"recon-123\" and session status is ACTIVE and createdDate is set to current timestamp"
    },
    {
      "id": "TC-CS-002",
      "title": "Create Chat Session without Reconciliation",
      "category": "Session Creation Tests",
      "given": "user \"user-456\" wants general assistance",
      "when": "createSession() is called with userId only (no reconciliationId)",
      "then": "ChatSession is created without reconciliation link and session is general-purpose (not context-specific) and session status is ACTIVE"
    },
    {
      "id": "TC-CS-003",
      "title": "Send User Message",
      "category": "Message Sending Tests",
      "given": "chat session \"session-111\" exists and user message content: \"What is the current match rate?\"",
      "when": "sendMessage() is called with sessionId and message",
      "then": "ChatMessage entity is created with role USER and message content is stored and message is linked to session \"session-111\" and timestamp is recorded"
    },
    {
      "id": "TC-CS-004",
      "title": "Generate AI Response Message",
      "category": "Message Sending Tests",
      "given": "chat session with user message \"What is the match rate?\" and session is linked to reconciliation \"recon-123\" and reconciliation has matchRate = 85.5%",
      "when": "generateAiResponse() is called",
      "then": "context is built with reconciliation statistics and AI service is invoked with context + user message and AI response is returned and ChatMessage entity is created with role ASSISTANT and response is saved to database"
    },
    {
      "id": "TC-CS-005",
      "title": "Build Context with Reconciliation Statistics",
      "category": "Context Building Tests",
      "given": "session linked to reconciliation \"recon-789\" and reconciliation has: matchRate: 92.3%, totalSourceRecords: 1,000, matchedRecords: 923, unmatchedRecords: 77, exception counts: 50 OPEN, 27 RESOLVED",
      "when": "buildContext() is called",
      "then": "context string includes reconciliation statistics formatted with match rate, total records, matched/unmatched counts, and exception counts"
    },
    {
      "id": "TC-CS-006",
      "title": "Include Recent Messages in Context",
      "category": "Context Building Tests",
      "given": "session has 10 previous messages and messages include user questions and AI responses",
      "when": "buildContext() is called",
      "then": "last 5 messages are included in context and message format is: \"USER: <message>\\nASSISTANT: <response>\" and context provides conversation continuity"
    },
    {
      "id": "TC-CS-007",
      "title": "Auto-Create Session on First Message",
      "category": "Auto-Session Creation Tests",
      "given": "no active session exists for user \"user-999\" and user sends message for reconciliation \"recon-555\"",
      "when": "sendMessage() is called without sessionId",
      "then": "new session is automatically created and session is linked to reconciliation \"recon-555\" and user message is added to new session and session ID is returned"
    },
    {
      "id": "TC-CS-008",
      "title": "Stream AI Response",
      "category": "Message Streaming Tests",
      "given": "chat session \"session-222\" and user message \"Explain fuzzy matching algorithm\"",
      "when": "streamAiResponse() is called",
      "then": "Flux<String> is returned for streaming and tokens are emitted as they're generated and complete response is assembled from stream and final message is saved to database with complete content"
    },
    {
      "id": "TC-CS-009",
      "title": "Handle Streaming Error",
      "category": "Message Streaming Tests",
      "given": "streaming is in progress and AI service connection drops mid-stream",
      "when": "Flux error occurs",
      "then": "partial response is saved with error flag and error message is logged and user is notified of incomplete response"
    },
    {
      "id": "TC-CS-010",
      "title": "Retrieve Message History",
      "category": "Message History Tests",
      "given": "session \"session-333\" has 20 messages and request for page 0, size 10",
      "when": "getMessages() is called with pagination",
      "then": "first 10 messages are returned and messages are ordered by timestamp ascending and each message includes: id, sessionId, role, content, timestamp"
    },
    {
      "id": "TC-CS-011",
      "title": "List Active Sessions for User",
      "category": "Session Management Tests",
      "given": "user \"user-777\" has: 3 ACTIVE sessions and 2 CLOSED sessions",
      "when": "listSessions() is called with userId \"user-777\"",
      "then": "only 3 ACTIVE sessions are returned and sessions are ordered by last message timestamp descending and each session includes: id, reconciliationId (if any), status, createdDate"
    }
  ],
  "testDataRequirements": {
    "chatSessionEntities": [
      "Sessions with and without reconciliationId",
      "Statuses: ACTIVE, CLOSED",
      "Multiple sessions per user"
    ],
    "chatMessageEntities": [
      "Roles: USER, ASSISTANT",
      "Various message contents (questions, responses, errors)",
      "Timestamps for ordering"
    ],
    "mockObjects": [
      "ChatSessionRepository with save/find operations",
      "ChatMessageRepository with pagination",
      "AiService mock for response generation",
      "Flux<String> for streaming responses"
    ],
    "sampleMessages": {
      "user": [
        "What is the match rate?",
        "Explain fuzzy matching",
        "How many exceptions are open?"
      ],
      "assistant": [
        "Statistics responses",
        "Algorithm explanations",
        "Guidance"
      ]
    },
    "reconciliationContextData": {
      "matchRates": ["50%", "85.5%", "92.3%", "100%"],
      "recordCounts": [100, 1000, 10000],
      "exceptionCountsByStatus": "Open and resolved counts"
    }
  }
}
